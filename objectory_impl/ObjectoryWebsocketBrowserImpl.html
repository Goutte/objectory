        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>ObjectoryWebsocketBrowserImpl class / objectory_impl Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="//fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="objectory_impl" data-type="ObjectoryWebsocketBrowserImpl">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../objectory_impl.html">objectory_impl</a> &rsaquo; <a href="../objectory_impl/ObjectoryWebsocketBrowserImpl.html">ObjectoryWebsocketBrowserImpl</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
</div>
<div class="content">
        <h2><strong>ObjectoryWebsocketBrowserImpl</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<pre class="source">
class ObjectoryWebsocketBrowserImpl extends Objectory{
 WebSocket webSocket;
 bool isConnected;
 Map&lt;int,Completer&gt; awaitedRequests = new Map&lt;int,Completer&gt;();
 int requestId = 0;
 ObjectoryWebsocketBrowserImpl(String uri,Function registerClassesCallback,bool dropCollectionsOnStartup):
   super(uri, registerClassesCallback, dropCollectionsOnStartup);

 Future open(){
   return setupWebsocket(uri);
 }
 
 ObjectoryCollection constructCollection() =&gt; new ObjectoryCollectionWebsocketBrowserImpl(this);

 Future&lt;bool&gt; setupWebsocket(String uri) {
   Completer completer = new Completer();
   webSocket = new WebSocket("ws://$uri/ws");
   webSocket.onOpen.listen((event) {
   
     isConnected = true;
     completer.complete(true);
   });

   webSocket.onClose.listen((e) {
     //log.fine('close $e');
     isConnected = false;
   });

   webSocket.onMessage.listen((m) {
     // TODO: Figure out if it's binary or not.
     // We could use print((new WebSocket('ws://.')).binaryType); -- but how does the server know?
     /*var reader = new FileReader();
     reader.onLoadEnd.listen(_onMessageRead);
     reader.readAsArrayBuffer(m.data);*/
     _onMessageRead(m.data);
   });
   return completer.future;
 }
 
 _onMessageRead(/*ProgressEvent event*/data) {
   /*FileReader reader = event.target;
   var data = reader.result;
   if (data is! List) {
     data = new Uint8List.view(data);
   }*/
   var jdata = new BSON().deserialize(new BsonBinary.from(JSON.decode(data)));
   //log.info('onmessage: $jdata');
   var message = new ObjectoryMessage.fromMessage(jdata);      
   int receivedRequestId = message.command['requestId'];
   if (receivedRequestId == null) {
     return;
   }
   var completer = awaitedRequests[receivedRequestId];
   if (completer != null) {
     //log.fine("Complete request: $receivedRequestId message: $message");
     completer.complete(message.content);
   } else {
     //log.shout('Not found completer for request: $receivedRequestId');
   }
 }
 Future _postMessage(Map command, Map content, [Map extParams]) {
   requestId++;
   command['requestId'] = requestId;
   webSocket.send(JSON.encode(new BSON().serialize({'header':command, 'content':content, 'extParams': extParams}).byteList));
   var completer = new Completer();
   awaitedRequests[requestId] = completer;
   return completer.future;
 }
 Map _createCommand(String command, String collection){
   return {'command': command, 'collection': collection};
 }
 ObjectId generateId() =&gt; new ObjectId(clientMode: true);

 Future doUpdate(String collection,ObjectId id, Map toUpdate) =&gt;
     _postMessage(_createCommand('update',collection),toUpdate,{"_id": id});


 Future insert(PersistentObject persistentObject) =&gt;
     _postMessage(_createCommand('insert',persistentObject.collectionName),persistentObject.map);

 Future remove(PersistentObject persistentObject) =&gt;
   _postMessage(_createCommand('remove',persistentObject.collectionName),persistentObject.map);

 Future&lt;Map&gt; dropDb() {
   return _postMessage(_createCommand('dropDb',null),{});
 }

 Future&lt;Map&gt; queryDb(Map map) {
   return _postMessage(_createCommand('queryDb',null),map);
 }

 Future&lt;Map&gt; wait(){
   return queryDb({"getlasterror":1});
 }

 void close(){
   webSocket.close();
 }
 Future dropCollections() {
   return Future.wait(getCollections().map(
       (collection) =&gt; _postMessage(_createCommand('dropCollection',collection),{})));
 }
}
</pre>
</div>
<h3>Extends</h3>
<p>
<span class="type-box"><span class="icon-class"></span><a href="../objectory_base/Objectory.html">Objectory</a></span>&nbsp;&gt;&nbsp;<span class="type-box"><span class="icon-class"></span><strong>ObjectoryWebsocketBrowserImpl</strong></span></p>
<div>
<h3>Constructors</h3>
<div class="method"><h4 id="">
<button class="show-code">Code</button>
new <strong>ObjectoryWebsocketBrowserImpl</strong>(<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a> uri, <a href="http://api.dartlang.org/dart_core/Function.html" ref="external">Function</a> registerClassesCallback, <a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a> dropCollectionsOnStartup) <a class="anchor-link" href="#"
              title="Permalink to ObjectoryWebsocketBrowserImpl.ObjectoryWebsocketBrowserImpl">#</a></h4>
<div class="doc">
<div class="inherited">
<p>Creates a new <a class="crossref" href="http://api.dartlang.org/dart_core/Object.html">Object</a> instance.</p>
<p><a class="crossref" href="http://api.dartlang.org/dart_core/Object.html">Object</a> instances have no meaningful state, and are only useful
through their identity. An <a class="crossref" href="http://api.dartlang.org/dart_core/Object.html">Object</a> instance is equal to itself
only.</p>
<div class="docs-inherited-from">docs inherited from <a href="http://api.dartlang.org/dart_core/Object.html" ref="external">Object</a> </div></div>
<pre class="source">
ObjectoryWebsocketBrowserImpl(String uri,Function registerClassesCallback,bool dropCollectionsOnStartup):
 super(uri, registerClassesCallback, dropCollectionsOnStartup);
</pre>
</div>
</div>
</div>
<div>
<h3>Properties</h3>
<div class="field"><h4 id="awaitedRequests">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a>&lt;<a href="http://api.dartlang.org/dart_core/int.html" ref="external">int</a>, <a href="http://api.dartlang.org/dart_async/Completer.html" ref="external">Completer</a>&gt;         <strong>awaitedRequests</strong> <a class="anchor-link"
            href="#awaitedRequests"
            title="Permalink to ObjectoryWebsocketBrowserImpl.awaitedRequests">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Map&lt;int,Completer&gt; awaitedRequests = new Map&lt;int,Completer&gt;()
</pre>
</div>
</div>
<div class="field inherited"><h4 id="cache">
<button class="show-code">Code</button>
final <a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a>&lt;<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a>, <a href="../persistent_object/BasePersistentObject.html">BasePersistentObject</a>&gt;         <strong>cache</strong> <a class="anchor-link"
            href="#cache"
            title="Permalink to ObjectoryWebsocketBrowserImpl.cache">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
final Map&lt;String,BasePersistentObject&gt; cache = new  Map&lt;String,BasePersistentObject&gt;()
</pre>
</div>
</div>
<div class="field inherited"><h4 id="dataListDecorator">
<button class="show-code">Code</button>
<a href="../objectory_base/DataListDecorator.html">DataListDecorator</a>         <strong>dataListDecorator</strong> <a class="anchor-link"
            href="#dataListDecorator"
            title="Permalink to ObjectoryWebsocketBrowserImpl.dataListDecorator">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
DataListDecorator dataListDecorator = (List list) =&gt; list
</pre>
</div>
</div>
<div class="field inherited"><h4 id="dataMapDecorator">
<button class="show-code">Code</button>
<a href="../objectory_base/DataMapDecorator.html">DataMapDecorator</a>         <strong>dataMapDecorator</strong> <a class="anchor-link"
            href="#dataMapDecorator"
            title="Permalink to ObjectoryWebsocketBrowserImpl.dataMapDecorator">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
DataMapDecorator dataMapDecorator = (Map map) =&gt; map
</pre>
</div>
</div>
<div class="field inherited"><h4 id="dropCollectionsOnStartup">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a>         <strong>dropCollectionsOnStartup</strong> <a class="anchor-link"
            href="#dropCollectionsOnStartup"
            title="Permalink to ObjectoryWebsocketBrowserImpl.dropCollectionsOnStartup">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
bool dropCollectionsOnStartup
</pre>
</div>
</div>
<div class="field"><h4 id="isConnected">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a>         <strong>isConnected</strong> <a class="anchor-link"
            href="#isConnected"
            title="Permalink to ObjectoryWebsocketBrowserImpl.isConnected">#</a>
        </h4>
        <div class="doc">
<pre class="source">
bool isConnected
</pre>
</div>
</div>
<div class="field inherited"><h4 id="registerClassesCallback">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Function.html" ref="external">Function</a>         <strong>registerClassesCallback</strong> <a class="anchor-link"
            href="#registerClassesCallback"
            title="Permalink to ObjectoryWebsocketBrowserImpl.registerClassesCallback">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
Function registerClassesCallback
</pre>
</div>
</div>
<div class="field"><h4 id="requestId">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html" ref="external">int</a>         <strong>requestId</strong> <a class="anchor-link"
            href="#requestId"
            title="Permalink to ObjectoryWebsocketBrowserImpl.requestId">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int requestId = 0
</pre>
</div>
</div>
<div class="field inherited"><h4 id="uri">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a>         <strong>uri</strong> <a class="anchor-link"
            href="#uri"
            title="Permalink to ObjectoryWebsocketBrowserImpl.uri">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
String uri
</pre>
</div>
</div>
<div class="field inherited"><h4 id="useFieldLevelUpdate">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a>         <strong>useFieldLevelUpdate</strong> <a class="anchor-link"
            href="#useFieldLevelUpdate"
            title="Permalink to ObjectoryWebsocketBrowserImpl.useFieldLevelUpdate">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
bool useFieldLevelUpdate = true
</pre>
</div>
</div>
<div class="field"><h4 id="webSocket">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_html/WebSocket.html" ref="external">WebSocket</a>         <strong>webSocket</strong> <a class="anchor-link"
            href="#webSocket"
            title="Permalink to ObjectoryWebsocketBrowserImpl.webSocket">#</a>
        </h4>
        <div class="doc">
<pre class="source">
WebSocket webSocket
</pre>
</div>
</div>
</div>
<div class="inherited">
<h3>Operators</h3>
<div class="method inherited"><h4 id="[]">
<button class="show-code">Code</button>
<a href="../objectory_base/ObjectoryCollection.html">ObjectoryCollection</a> <strong>operator []</strong>(<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType) <a class="anchor-link" href="#[]"
              title="Permalink to ObjectoryWebsocketBrowserImpl.operator []">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
ObjectoryCollection operator[](Type classType) =&gt; _collections[classType];
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="close">
<button class="show-code">Code</button>
void <strong>close</strong>() <a class="anchor-link" href="#close"
              title="Permalink to ObjectoryWebsocketBrowserImpl.close">#</a></h4>
<div class="doc">
<pre class="source">
void close(){
 webSocket.close();
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="completeFindOne">
<button class="show-code">Code</button>
dynamic <strong>completeFindOne</strong>(<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a> map, <a href="http://api.dartlang.org/dart_async/Completer.html" ref="external">Completer</a> completer, <a href="../objectory_query/ObjectoryQueryBuilder.html">ObjectoryQueryBuilder</a> selector, <a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType) <a class="anchor-link" href="#completeFindOne"
              title="Permalink to ObjectoryWebsocketBrowserImpl.completeFindOne">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
completeFindOne(Map map,Completer completer,ObjectoryQueryBuilder selector,Type classType) {
 var obj;
 if (map == null) {
   completer.complete(null);
 }
 else {
   obj = objectory.map2Object(classType,map);
   if ((selector == null) ||  !selector.paramFetchLinks) {
     completer.complete(obj);
   } else {
     obj.fetchLinks().then((_) {
       completer.complete(obj);
     });  
   }
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="constructCollection">
<button class="show-code">Code</button>
<a href="../objectory_base/ObjectoryCollection.html">ObjectoryCollection</a> <strong>constructCollection</strong>() <a class="anchor-link" href="#constructCollection"
              title="Permalink to ObjectoryWebsocketBrowserImpl.constructCollection">#</a></h4>
<div class="doc">
<pre class="source">
ObjectoryCollection constructCollection() =&gt; new ObjectoryCollectionWebsocketBrowserImpl(this);
</pre>
</div>
</div>
<div class="method inherited"><h4 id="createTypedList">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/List.html" ref="external">List</a> <strong>createTypedList</strong>(<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType) <a class="anchor-link" href="#createTypedList"
              title="Permalink to ObjectoryWebsocketBrowserImpl.createTypedList">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
List createTypedList(Type classType) {
 return _listFactories[classType]();
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="dbRef2Object">
<button class="show-code">Code</button>
<a href="../persistent_object/PersistentObject.html">PersistentObject</a> <strong>dbRef2Object</strong>(<a href="../bson/DbRef.html">DbRef</a> dbRef) <a class="anchor-link" href="#dbRef2Object"
              title="Permalink to ObjectoryWebsocketBrowserImpl.dbRef2Object">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
PersistentObject dbRef2Object(DbRef dbRef) {
 return findInCacheOrGetProxy(dbRef.id, objectory.getClassTypeByCollection(dbRef.collection));
}
</pre>
</div>
</div>
<div class="method"><h4 id="doUpdate">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>doUpdate</strong>(<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a> collection, <a href="../bson/ObjectId.html">ObjectId</a> id, <a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a> toUpdate) <a class="anchor-link" href="#doUpdate"
              title="Permalink to ObjectoryWebsocketBrowserImpl.doUpdate">#</a></h4>
<div class="doc">
<pre class="source">
Future doUpdate(String collection,ObjectId id, Map toUpdate) =&gt;
   _postMessage(_createCommand('update',collection),toUpdate,{"_id": id});
</pre>
</div>
</div>
<div class="method"><h4 id="dropCollections">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>dropCollections</strong>() <a class="anchor-link" href="#dropCollections"
              title="Permalink to ObjectoryWebsocketBrowserImpl.dropCollections">#</a></h4>
<div class="doc">
<pre class="source">
Future dropCollections() {
 return Future.wait(getCollections().map(
     (collection) =&gt; _postMessage(_createCommand('dropCollection',collection),{})));
}
</pre>
</div>
</div>
<div class="method"><h4 id="dropDb">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a>&gt; <strong>dropDb</strong>() <a class="anchor-link" href="#dropDb"
              title="Permalink to ObjectoryWebsocketBrowserImpl.dropDb">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;Map&gt; dropDb() {
 return _postMessage(_createCommand('dropDb',null),{});
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="findInCacheOrGetProxy">
<button class="show-code">Code</button>
<a href="../persistent_object/PersistentObject.html">PersistentObject</a> <strong>findInCacheOrGetProxy</strong>(id, <a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType) <a class="anchor-link" href="#findInCacheOrGetProxy"
              title="Permalink to ObjectoryWebsocketBrowserImpl.findInCacheOrGetProxy">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
PersistentObject findInCacheOrGetProxy(var id, Type classType) {
 if (id == null) {
   return null;
 }
 PersistentObject result = _findInCache(id);
 if (result == null) {
   result = objectory.newInstance(classType);
   result.id = id;
 }
 return result;
}
</pre>
</div>
</div>
<div class="method"><h4 id="generateId">
<button class="show-code">Code</button>
<a href="../bson/ObjectId.html">ObjectId</a> <strong>generateId</strong>() <a class="anchor-link" href="#generateId"
              title="Permalink to ObjectoryWebsocketBrowserImpl.generateId">#</a></h4>
<div class="doc">
<pre class="source">
ObjectId generateId() =&gt; new ObjectId(clientMode: true);
</pre>
</div>
</div>
<div class="method inherited"><h4 id="getClassTypeByCollection">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> <strong>getClassTypeByCollection</strong>(<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a> collectionName) <a class="anchor-link" href="#getClassTypeByCollection"
              title="Permalink to ObjectoryWebsocketBrowserImpl.getClassTypeByCollection">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
Type getClassTypeByCollection(String collectionName) =&gt; _collectionNameToTypeMap[collectionName];
</pre>
</div>
</div>
<div class="method inherited"><h4 id="getCollections">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/List.html" ref="external">List</a>&lt;<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a>&gt; <strong>getCollections</strong>() <a class="anchor-link" href="#getCollections"
              title="Permalink to ObjectoryWebsocketBrowserImpl.getCollections">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
List&lt;String&gt; getCollections() =&gt; _collections.values.map((ObjectoryCollection oc) =&gt; oc.collectionName).toList();
</pre>
</div>
</div>
<div class="method inherited"><h4 id="initDomainModel">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a>&gt; <strong>initDomainModel</strong>() <a class="anchor-link" href="#initDomainModel"
              title="Permalink to ObjectoryWebsocketBrowserImpl.initDomainModel">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
Future&lt;bool&gt; initDomainModel() {
 registerClassesCallback();
 return open().then((_){
   if (dropCollectionsOnStartup) {
     return objectory.dropCollections();
   }
 });
}
</pre>
</div>
</div>
<div class="method"><h4 id="insert">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>insert</strong>(<a href="../persistent_object/PersistentObject.html">PersistentObject</a> persistentObject) <a class="anchor-link" href="#insert"
              title="Permalink to ObjectoryWebsocketBrowserImpl.insert">#</a></h4>
<div class="doc">
<pre class="source">
Future insert(PersistentObject persistentObject) =&gt;
   _postMessage(_createCommand('insert',persistentObject.collectionName),persistentObject.map);
</pre>
</div>
</div>
<div class="method inherited"><h4 id="map2Object">
<button class="show-code">Code</button>
<a href="../persistent_object/BasePersistentObject.html">BasePersistentObject</a> <strong>map2Object</strong>(<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType, <a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a> map) <a class="anchor-link" href="#map2Object"
              title="Permalink to ObjectoryWebsocketBrowserImpl.map2Object">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
BasePersistentObject map2Object(Type classType, Map map){
 if (map == null) {
   map = new LinkedHashMap();
 }
 var result = newInstance(classType);
 result.map = map;
 if (result is PersistentObject){
   result.id = map["_id"];
 }
 if (result is PersistentObject) {
   if (result.id != null) {
     objectory._addToCache(result);
   }
 }
 return result;
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="newInstance">
<button class="show-code">Code</button>
<a href="../persistent_object/BasePersistentObject.html">BasePersistentObject</a> <strong>newInstance</strong>(<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType) <a class="anchor-link" href="#newInstance"
              title="Permalink to ObjectoryWebsocketBrowserImpl.newInstance">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
BasePersistentObject newInstance(Type classType){
 if (_factories.containsKey(classType)){
   return _factories[classType]();
 }
 throw new Exception('Class $classType have not been registered in Objectory');
}
</pre>
</div>
</div>
<div class="method"><h4 id="open">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>open</strong>() <a class="anchor-link" href="#open"
              title="Permalink to ObjectoryWebsocketBrowserImpl.open">#</a></h4>
<div class="doc">
<pre class="source">
Future open(){
 return setupWebsocket(uri);
}
</pre>
</div>
</div>
<div class="method"><h4 id="queryDb">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a>&gt; <strong>queryDb</strong>(<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a> map) <a class="anchor-link" href="#queryDb"
              title="Permalink to ObjectoryWebsocketBrowserImpl.queryDb">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;Map&gt; queryDb(Map map) {
 return _postMessage(_createCommand('queryDb',null),map);
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="registerClass">
<button class="show-code">Code</button>
void <strong>registerClass</strong>(<a href="http://api.dartlang.org/dart_core/Type.html" ref="external">Type</a> classType, <a href="../objectory_base/FactoryMethod.html">FactoryMethod</a> factory, [<a href="../objectory_base/FactoryMethod.html">FactoryMethod</a> listFactory]) <a class="anchor-link" href="#registerClass"
              title="Permalink to ObjectoryWebsocketBrowserImpl.registerClass">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
void registerClass(Type classType,FactoryMethod factory,[FactoryMethod listFactory]){
 _factories[classType] = factory;
 _listFactories[classType] = (listFactory==null ? ()=&gt;new List&lt;PersistentObject&gt;() : listFactory);
 BasePersistentObject obj = factory();
 if (obj is PersistentObject) {
   var collectionName = obj.collectionName;
   _collectionNameToTypeMap[collectionName] = classType;
   _collections[classType] = _createObjectoryCollection(classType,collectionName);
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="remove">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>remove</strong>(<a href="../persistent_object/PersistentObject.html">PersistentObject</a> persistentObject) <a class="anchor-link" href="#remove"
              title="Permalink to ObjectoryWebsocketBrowserImpl.remove">#</a></h4>
<div class="doc">
<pre class="source">
Future remove(PersistentObject persistentObject) =&gt;
 _postMessage(_createCommand('remove',persistentObject.collectionName),persistentObject.map);
</pre>
</div>
</div>
<div class="method inherited"><h4 id="save">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>save</strong>(<a href="../persistent_object/PersistentObject.html">PersistentObject</a> persistentObject) <a class="anchor-link" href="#save"
              title="Permalink to ObjectoryWebsocketBrowserImpl.save">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
Future save(PersistentObject persistentObject){
 Future res;
 if (persistentObject.id != null){
   res = update(persistentObject);
 }
 else{
   persistentObject.id = generateId();
   persistentObject.map["_id"] = persistentObject.id;
   objectory._addToCache(persistentObject);
   res =  insert(persistentObject);
 }
 persistentObject.dirtyFields.clear();
 return res;
}
</pre>
</div>
</div>
<div class="method"><h4 id="setupWebsocket">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html" ref="external">bool</a>&gt; <strong>setupWebsocket</strong>(<a href="http://api.dartlang.org/dart_core/String.html" ref="external">String</a> uri) <a class="anchor-link" href="#setupWebsocket"
              title="Permalink to ObjectoryWebsocketBrowserImpl.setupWebsocket">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;bool&gt; setupWebsocket(String uri) {
 Completer completer = new Completer();
 webSocket = new WebSocket("ws://$uri/ws");
 webSocket.onOpen.listen((event) {
 
   isConnected = true;
   completer.complete(true);
 });

 webSocket.onClose.listen((e) {
   //log.fine('close $e');
   isConnected = false;
 });

 webSocket.onMessage.listen((m) {
   // TODO: Figure out if it's binary or not.
   // We could use print((new WebSocket('ws://.')).binaryType); -- but how does the server know?
   /*var reader = new FileReader();
   reader.onLoadEnd.listen(_onMessageRead);
   reader.readAsArrayBuffer(m.data);*/
   _onMessageRead(m.data);
 });
 return completer.future;
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="update">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a> <strong>update</strong>(<a href="../persistent_object/PersistentObject.html">PersistentObject</a> persistentObject) <a class="anchor-link" href="#update"
              title="Permalink to ObjectoryWebsocketBrowserImpl.update">#</a></h4>
<div class="inherited-from">inherited from <a href="../objectory_base/Objectory.html">Objectory</a> </div><div class="doc">
<pre class="source">
Future update(PersistentObject persistentObject) {
 var id = persistentObject.id;
 if (id == null) {
   return new Future.error(new Exception('Update operation on object with null id'));
 }
 Map toUpdate = _getMapForUpdateCommand(persistentObject);
 if (toUpdate.isEmpty) {
   return new Future.value({'ok': 1.0, 'warn': 'Update operation called without actual changes'});
 }
 return doUpdate(persistentObject.collectionName,id,toUpdate);
}
</pre>
</div>
</div>
<div class="method"><h4 id="wait">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_async/Future.html" ref="external">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html" ref="external">Map</a>&gt; <strong>wait</strong>() <a class="anchor-link" href="#wait"
              title="Permalink to ObjectoryWebsocketBrowserImpl.wait">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;Map&gt; wait(){
 return queryDb({"getlasterror":1});
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        <div class="footer">
          
        </div>
        <script async src="../client-live-nav.js"></script>
        </body></html>
        
